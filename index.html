<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LPU TGPA & CGPA Calculator</title>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1f1f1f">
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="LPU CGPA Calculator | Accurate CGPA to Percentage Converter Online">
    <meta property="og:description" content="Fast and reliable LPU CGPA Calculator. Instantly convert CGPA to percentage. Tailored for Lovely Professional University students.">
    <meta property="og:url" content="https://cgpacalculator.lputech.xyz/">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://cgpacalculator.lputech.xyz/assets/images/preview-image.png"> 
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="LPU CGPA Calculator | Convert CGPA to Percentage Easily">
    <meta name="twitter:description" content="Use this free tool to calculate and convert your LPU CGPA to percentage in seconds. Perfect for Lovely Professional University students.">
    <meta name="twitter:image" content="https://cgpacalculator.lputech.xyz/assets/images/preview-image.png"> 
    <link rel="manifest" href="manifest.json">
    <!-- End PWA Meta Tags -->

    <!-- jQuery CDN -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable Plugin for easy table generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
    <!-- Google Fonts - Inter for clean typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for light/dark mode and range input */
        :root {
            --background-color-dark: #121212;
            --container-bg-dark: #1f1f1f;
            --text-color-dark: #ffffff;
            --input-bg-dark: #2e2e2e;
            --input-border-dark: #555;
            --table-border-dark: #444;
            --semester-bg-dark: #2a2a2a;
            --button-bg-dark: #000000;
            --button-hover-bg-dark: #1a1a1a;
            --highlight-color: #ffcb05; /* LPU Gold for dark mode */
            --accent-color: #007bff; /* Blue for range slider */

            /* Updated Light mode variables */
            --background-color-light: #f8f9fa; /* Lighter background */
            --container-bg-light: #ffffff; /* Pure white for container */
            --text-color-light: #212529; /* Darker text for contrast */
            --input-bg-light: #e9ecef; /* Light gray for inputs */
            --input-border-light: #ced4da; /* Subtle border for inputs */
            --table-border-light: #dee2e6; /* Light gray for table borders */
            --semester-bg-light: #f1f3f5; /* Slightly darker light gray for semesters */
            --button-bg-light: #007bff; /* Primary blue for buttons */
            --button-hover-bg-light: #0056b3; /* Darker blue on hover */
            --light-mode-highlight: #0056b3; /* Blue for highlights in light mode */
        }

        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark mode default */
        body.dark-mode {
            background-color: var(--background-color-dark);
            color: var(--text-color-dark);
        }
        .dark-mode .container {
            background: var(--container-bg-dark);
        }
        .dark-mode h1, .dark-mode h2, .dark-mode #result, .dark-mode #cgpaResult {
            color: var(--highlight-color);
        }
        .dark-mode input {
            background-color: var(--input-bg-dark);
            color: var(--text-color-dark);
            border-color: var(--input-border-dark);
        }
        .dark-mode table, .dark-mode th, .dark-mode td {
            border-color: var(--table-border-dark);
        }
        .dark-mode .semester {
            background-color: var(--semester-bg-dark);
        }
        .dark-mode button {
            background-color: var(--button-bg-dark);
            color: var(--highlight-color);
        }
        .dark-mode button:hover {
            background-color: var(--button-hover-bg-dark);
            color: var(--text-color-dark);
        }
        .dark-mode input[type=range] {
            accent-color: var(--accent-color);
        }

        /* Light mode */
        body.light-mode {
            background-color: var(--background-color-light);
            color: var(--text-color-light);
        }
        .light-mode .container {
            background: var(--container-bg-light);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* Subtle shadow in light mode */
        }
        .light-mode h1, .light-mode h2 {
            color: var(--light-mode-highlight); /* Use blue for headings in light mode */
        }
        /* Explicitly target result text for light mode */
        .light-mode #result, .light-mode #cgpaResult {
            color: #ffffff; /* Ensure white text for results in light mode */
            background-color: var(--light-mode-highlight); /* Ensure a solid background for contrast */
        }
        .light-mode input {
            background-color: var(--input-bg-light);
            color: var(--text-color-light);
            border-color: var(--input-border-light);
        }
        .light-mode table, .light-mode th, .light-mode td {
            border-color: var(--table-border-light);
        }
        .light-mode .semester {
            background-color: var(--semester-bg-light);
        }
        .light-mode button {
            background-color: var(--button-bg-light);
            color: #ffffff; /* White text for light mode buttons */
        }
        .light-mode button:hover {
            background-color: var(--button-hover-bg-light);
            color: #ffffff;
        }
        .light-mode input[type=range] {
            accent-color: var(--accent-color);
        }
        .light-mode .bg-gray-800 { /* Table header and result box in light mode */
            background-color: var(--light-mode-highlight); /* Use blue for these elements */
            color: #ffffff; /* Ensure text is white */
        }
        .light-mode .bg-gray-900 { /* Table rows in light mode */
            background-color: var(--container-bg-light);
            color: var(--text-color-light);
        }
        .light-mode .even\:bg-gray-850 { /* Alternating row color in light mode */
            background-color: var(--semester-bg-light);
        }
        .light-mode .border-gray-700 { /* Table borders within light mode */
            border-color: var(--table-border-light);
        }
        .light-mode .text-gray-400 { /* Grade point display text */
            color: #6c757d; /* Darker gray for better readability */
        }


        /* Message box styling (adjusted for light mode consistency) */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .message-box {
            background: var(--container-bg-light);
            color: var(--text-color-light);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .message-box-button {
            background-color: var(--button-bg-light);
            color: #ffffff;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .message-box-button:hover {
            background-color: var(--button-hover-bg-light);
            color: #ffffff;
        }

        /* Responsive adjustments for table */
        @media (max-width: 640px) {
            table, thead, tbody, th, td, tr {
                display: block;
            }
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr {
                border: 1px solid var(--table-border-dark);
                margin-bottom: 10px;
                border-radius: 8px;
                overflow: hidden;
            }
            .light-mode tr {
                border: 1px solid var(--table-border-light);
            }
            td {
                border: none;
                position: relative;
                padding: 10px;
                text-align: left;
                white-space: normal;
                min-height: 48px;
                display: flex;
                flex-direction: column;
                align-items: flex-start;
            }
            /* Hide the old pseudo-element labels */
            td:before {
                content: none;
            }

            .mobile-label-input-group {
                display: flex;
                flex-direction: column;
                width: 100%;
            }

            .mobile-label {
                font-weight: bold;
                margin-bottom: 4px;
                text-align: left;
                color: var(--text-color-dark);
                font-size: 0.9rem;
            }

            .light-mode .mobile-label {
                color: var(--text-color-light);
            }

            td input {
                flex-grow: 1;
                min-width: 0;
            }
            td .grade-point-display {
                flex-shrink: 0;
            }

            /* Specific fix for semester labels and inputs on mobile */
            #semesters .semester label {
                width: 100%;
            }
            #semesters .semester label input {
                width: 100%;
            }
        }

        /* Tour Highlight Style */
        .tour-highlight {
            box-shadow: 0 0 0 5px var(--highlight-color);
            transition: box-shadow 0.3s ease-in-out;
            position: relative;
            z-index: 1002;
        }
        body.light-mode .tour-highlight {
            box-shadow: 0 0 0 5px var(--light-mode-highlight);
        }

        /* Side Navigation Styles */
        #sidebar.active {
            transform: translateX(0);
        }
        /* Initial state for sidebar: off-screen to the left */
        #sidebar {
            transform: translateX(-100%);
            left: 0; /* Ensure it's positioned from the left edge */
            transition: transform 0.3s ease-in-out;
        }

        /* Burger button dynamic hide/show */
        #toggle-bar {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #toggle-bar.hidden-on-scroll {
            transform: translateY(-100%);
            opacity: 0;
        }

        /* New styles for dimmed content effect */
        #mainCalculatorContent, #semesterHistoryPage, #developerInfoPage {
            transition: filter 0.3s ease, transform 0.3s ease; /* Smooth transition for the effect */
        }

        #mainCalculatorContent.dimmed-content,
        #semesterHistoryPage.dimmed-content,
        #developerInfoPage.dimmed-content {
            filter: brightness(0.5);
            transform: scale(0.98);
            pointer-events: none;
        }

        /* Explicit styles for text and number input elements to ensure visibility and sizing */
        input[type="text"],
        input[type="number"] {
            width: 100%; /* Ensure inputs take full width of their container */
            min-height: 40px; /* Ensure a minimum visible height */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
            padding: 8px; /* Standard padding, matching p-2 */
            border-width: 1px; /* Standard border width */
            border-style: solid; /* Ensure border is solid */
            border-radius: 0.375rem; /* rounded-md equivalent */
            outline: none; /* Remove default focus outline */
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            border-color: var(--highlight-color); /* Yellow glow for dark mode */
            box-shadow: 0 0 0 2px rgba(255, 203, 5, 0.5);
        }

        body.light-mode input[type="text"]:focus,
        body.light-mode input[type="number"]:focus {
            border-color: var(--light-mode-highlight); /* Blue glow for light mode */
            box-shadow: 0 0 0 2px rgba(0, 86, 179, 0.5);
        }

        /* Custom Autocomplete / Subject Suggestions Styling */
        .subject-input-wrapper {
            position: relative; /* Needed for positioning the suggestions div */
            width: 100%;
        }

        .subject-suggestions {
            position: absolute;
            top: 100%; /* Position right below the input */
            left: 0;
            right: 0;
            z-index: 10; /* Ensure it appears above other content */
            background-color: var(--container-bg-dark);
            border: 1px solid var(--input-border-dark);
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 200px; /* Limit height and make it scrollable */
            overflow-y: auto;
            display: none; /* Hidden by default */
            margin-top: 4px; /* Small gap between input and suggestions */
        }

        body.light-mode .subject-suggestions {
            background-color: var(--container-bg-light);
            border: 1px solid var(--input-border-light);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .subject-suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            color: var(--text-color-dark);
            font-size: 0.95rem;
            transition: background-color 0.2s ease;
        }

        body.light-mode .subject-suggestion-item {
            color: var(--text-color-light);
        }

        .subject-suggestion-item:hover,
        .subject-suggestion-item.selected { /* For keyboard navigation highlight */
            background-color: var(--highlight-color); /* LPU Gold for dark mode */
            color: var(--background-color-dark); /* Dark text on hover */
        }

        body.light-mode .subject-suggestion-item:hover,
        body.light-mode .subject-suggestion-item.selected {
            background-color: var(--light-mode-highlight); /* Blue for light mode */
            color: #ffffff; /* White text on hover */
        }
    </style>
</head>
<body class="dark-mode">
    <div id="mainCalculatorContent" class="container mx-auto p-5 rounded-xl shadow-lg max-w-5xl my-8">
        <div class="flex justify-between items-center mb-6 relative">
            <!-- Burger Menu Icon (visible on sm and down) -->
            <button id="toggle-bar" class="fixed top-3 left-3 z-[9998] p-3 rounded-full bg-gray-700 text-white text-xl hover:bg-gray-600 transition-colors duration-300 sm:hidden">
                ☰
            </button>

            <h1 class="text-3xl sm:text-4xl font-bold text-center flex-grow ml-12 sm:ml-0">LPU TGPA & CGPA Calculator</h1>
            <button id="themeToggle" class="p-2 rounded-full bg-gray-700 text-white text-xl hover:bg-gray-600 transition-colors duration-300">💡</button>
        </div>

        <!-- Desktop Nav Bar (visible on sm and up) -->
        <nav id="desktopNav" class="hidden sm:flex justify-center gap-4 p-2 bg-gray-800 rounded-full shadow-md mb-6">
            <a href="#" onclick="showSemesterHistoryPage(); return false;" class="text-lg font-semibold px-4 py-2 rounded-full hover:bg-gray-700 hover:text-yellow-500 transition-colors duration-200">Semester History</a>
            <a href="#" onclick="showAboutUs(); return false;" class="text-lg font-semibold px-4 py-2 rounded-full hover:bg-gray-700 hover:text-yellow-500 transition-colors duration-200">About Us</a>
            <a href="#" onclick="showContactUs(); return false;" class="text-lg font-semibold px-4 py-2 rounded-full hover:bg-gray-700 hover:text-yellow-500 transition-colors duration-200">Contact Us</a>
            <a href="#" onclick="showDeveloperInfoPage(); return false;" class="text-lg font-semibold px-4 py-2 rounded-full hover:bg-gray-700 hover:text-yellow-500 transition-colors duration-200">Meet the Developer</a>
            <a href="#" onclick="showAppVersion(); return false;" class="text-lg font-semibold px-4 py-2 rounded-full hover:bg-gray-700 hover:text-yellow-500 transition-colors duration-200">App Version</a>
        </nav>

        <label for="subjectCount" class="block mb-2 text-lg">Select Number of Subjects: <span id="subjectCountDisplay" class="font-semibold">3</span></label>
        <input type="range" id="subjectCount" min="1" max="15" value="3" oninput="updateSubjectCount(this.value)" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 mb-6">

        <h2 class="text-2xl sm:text-3xl font-bold text-center mb-4">Enter Subject Data for Current Semester</h2>
        <div class="overflow-x-auto">
            <table id="gradeTable" class="min-w-full border-collapse mb-4">
                <thead>
                    <tr class="bg-gray-800 text-gray-200">
                        <th class="py-3 px-2 sm:px-4 border border-gray-700 rounded-tl-lg">Subject</th>
                        <th class="py-3 px-2 sm:px-4 border border-gray-700">Grade (or Marks)</th>
                        <th class="py-3 px-2 sm:px-4 border border-gray-700">Credit</th>
                        <th class="py-3 px-2 sm:px-4 border border-gray-700 rounded-tr-lg">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be added here by JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <button onclick="calculateTGPA()" class="bg-black text-yellow-500 py-3 px-6 rounded-lg text-lg font-bold hover:bg-gray-900 transition-all duration-300 shadow-md">🎯 Calculate TGPA</button>
            <button onclick="addRow()" class="bg-black text-yellow-500 py-3 px-6 rounded-lg text-lg font-bold hover:bg-gray-900 transition-all duration-300 shadow-md">➕ Add Subject</button>
            <button onclick="autofillSubjects()" class="bg-black text-yellow-500 py-3 px-6 rounded-lg text-lg font-bold hover:bg-gray-900 transition-all duration-300 shadow-md">🔁 Autofill Previous</button>
            <button onclick="resetCurrentTable()" class="bg-black text-yellow-500 py-3 px-6 rounded-lg text-lg font-bold hover:bg-gray-900 transition-all duration-300 shadow-md">🔄 Reset Current Table</button>
        </div>
        <button onclick="deleteCurrentSubjectsData()" class="bg-black text-yellow-500 py-3 px-6 rounded-lg text-lg font-bold hover:bg-gray-900 transition-all duration-300 shadow-md w-full sm:w-auto mx-auto block mb-6">🗑️ Delete Current Subjects Data</button>

        <div id="result" class="text-center text-xl font-bold mt-6 mb-4 p-4 bg-gray-800 rounded-md"></div>
        <button id="saveCurrentSemesterBtn" onclick="saveCurrentSemesterToHistory()" class="bg-green-600 text-white py-3 px-6 rounded-lg text-lg font-bold hover:bg-green-700 transition-all duration-300 shadow-md w-full sm:w-auto mx-auto block mb-8">
            💾 Save Current Semester TGPA
        </button>

        <hr class="border-t-2 border-gray-700 my-8">

        <h2 class="text-2xl sm:text-3xl font-bold text-center mb-4">Enter TGPA for Each Semester (for CGPA calculation)</h2>
        <div id="semesters" class="flex flex-col gap-4 mb-6"></div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
            <button onclick="addSemester()" class="bg-black text-yellow-500 py-3 px-6 rounded-lg text-lg font-bold hover:bg-gray-900 transition-all duration-300 shadow-md">➕ Add Semester</button>
            <button onclick="calculateCGPA()" class="bg-black text-yellow-500 py-3 px-6 rounded-lg text-lg font-bold hover:bg-gray-900 transition-all duration-300 shadow-md">📊 Calculate CGPA</button>
        </div>
        <div id="cgpaResult" class="text-center text-xl font-bold mt-6 mb-8 p-4 bg-gray-800 rounded-md"></div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
            <button onclick="generatePDF()" class="bg-black text-yellow-500 py-3 px-6 rounded-lg text-lg font-bold hover:bg-gray-900 transition-all duration-300 shadow-md w-full sm:w-auto mx-auto block">📄 Download PDF Report</button>
            <button id="shareButton" onclick="shareReport()" class="bg-blue-600 text-white py-3 px-6 rounded-lg text-lg font-bold hover:bg-blue-700 transition-all duration-300 shadow-md w-full sm:w-auto mx-auto block">🔗 Share Report</button>
        </div>
    </div>

    <!-- Semester History Page -->
    <div id="semesterHistoryPage" class="container mx-auto p-5 rounded-xl shadow-lg max-w-5xl my-8 hidden">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-6 text-yellow-500">Semester History</h1>
        <p id="historyUserInfo" class="text-center text-sm text-gray-400 mb-4">Data is stored locally in your browser.</p>
        <div id="savedSemestersList" class="flex flex-col gap-4 mb-6">
            <!-- Saved semesters will be loaded here by JavaScript -->
        </div>
        <button onclick="showCalculatorPage()" class="bg-blue-600 text-white py-3 px-6 rounded-lg text-lg font-bold hover:bg-blue-700 transition-all duration-300 shadow-md w-full sm:w-auto mx-auto block">
            ← Back to Calculator
        </button>
        <button onclick="deleteSavedData()" class="bg-red-600 text-white py-3 px-6 rounded-lg text-lg font-bold hover:bg-red-700 transition-all duration-300 shadow-md w-full sm:w-auto mx-auto block mt-4">
            🗑️ Delete ALL saved data
        </button>
    </div>

    <!-- Meet the Developer Page -->
    <div id="developerInfoPage" class="container mx-auto p-5 rounded-xl shadow-lg max-w-5xl my-8 hidden">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-6 text-yellow-500">Meet the Developer</h1>
        <div class="text-center mb-8">
            <img src="Profile Photo.jpg" alt="Developer Avatar" class="mx-auto rounded-full w-32 h-32 mb-4 object-cover border-4 border-yellow-500">
            <h2 class="text-2xl font-semibold text-white">Himanshu Kumar</h2>
            <p class="text-gray-400">Passionate about creating useful tools and applications.</p>
        </div>
        
        <div class="flex flex-col items-center gap-4 mb-8">
            <a href="https://github.com/Himanshu9097" target="_blank" class="flex items-center gap-2 bg-gray-700 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors duration-300 w-full sm:w-auto justify-center">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.47.087.68-.217.68-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.529 2.341 1.087 2.91.832.092-.647.35-1.087.636-1.332-2.22-.253-4.555-1.113-4.555-4.953 0-1.096.392-1.988 1.03-2.69-.104-.253-.448-1.274.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.376.202 2.398.098 2.651.638.702 1.029 1.593 1.029 2.69 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.336-.012 2.419-.012 2.747 0 .268.21.577.686.483C21.133 20.207 24 16.453 24 12.017 24 6.484 19.522 2 12 2Z" clip-rule="evenodd" /></svg>
                GitHub: Himanshu9097
            </a>
            <a href="https://www.instagram.com/enhimanshu13/" target="_blank" class="flex items-center gap-2 bg-gray-700 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors duration-300 w-full sm:w-auto justify-center">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12.315 2c2.43 0 2.715.01 3.65.047 1.005.038 1.797.232 2.426.465.66.237 1.16.545 1.597.977.436.432.744.937.978 1.597.234.629.428 1.42.465 2.426.037.935.047 1.22.047 3.65 0 2.43-.01 2.715-.047 3.65-.038 1.005-.232 1.797-.465 2.426-.237.66-.545 1.16-.977 1.597-.432.436-.937.744-1.597.978-.629.234-1.42.428-2.426.465-.935.037-1.22.047-3.65.047-2.43 0-2.715-.01-3.65-.047-1.005-.038-1.797-.232-2.426-.465-.66-.237-1.16-.545-1.597-.977-.436-.432-.744-.937-.978-1.597-.234-.629-.428-1.42-.465-2.426-.037-.935-.047-1.22-.047-3.65 0-2.43.01-2.715.047-3.65.038-1.005.232-1.797.465-2.426.237-.66.545-1.16.977-1.597.432-.436.937-.744 1.597-.978.629-.234 1.42-.428 2.426-.465.935-.037 1.22-.047 3.65-.047ZM12 21.355c-1.79 0-2.008-.007-2.715-.04-1.005-.037-1.63-.227-2.07-.385-.44-.158-.75-.33-1.02-.6-.27-.27-.442-.58-.6-.99-.158-.44-.348-1.065-.385-2.07-.033-.707-.04-1.008-.04-2.715s.007-2.008.04-2.715c.037-1.005.227-1.63.385-2.07.158-.44.33-.75.6-.99.27-.27.58-.442.99-.6.44-.158 1.065-.348 2.07-.385.707-.033 1.008-.04 2.715-.04s2.008.007 2.715.04c1.005.037 1.63.227 2.07.385.44.158.75.33 1.02.6.27.27.442.58.6.99.158.44.348 1.065.385 2.07.033.707.04 1.008.04 2.715s-.007 2.008-.04 2.715c-.037 1.005-.227 1.63-.385 2.07-.158.44-.33.75-.6.99-.27.27-.58.442-.99.6-.44.158-1.065.348-2.07.385-.707.033-1.008.04-2.715.04Zm0-15.82c-3.13 0-3.51.01-4.74.056-1.23.046-2.02.24-2.58.45-.56.21-.96.48-1.29.81-.33.33-.6.73-.81 1.29-.21.56-.404 1.35-.45 2.58-.046 1.23-.056 1.61-.056 4.74s.01 3.51.056 4.74c.046 1.23.24 2.02.45 2.58.21.56.48.96.81 1.29.33.33.73.6 1.29.81.56.21 1.35.404 2.58.45 1.23.046 1.61.056 4.74.056s3.51-.01 4.74-.056c1.23-.046 2.02-.24 2.58-.45.56-.21.96-.48 1.29-.81.33-.33.6-.73.81-1.29.21-.56.404-1.35.45-2.58.046-1.23.056-1.61.056-4.74s-.01-3.51-.056-4.74c-.046-1.23-.24-2.02-.45-2.58-.21-.56-.48-.96-.81-1.29-.33-.33-.73-.6-1.29-.81-.56-.21-1.35-.404-2.58-.45-1.23-.046-1.61-.056-4.74-.056Zm0 10.82a4.82 4.82 0 1 1 0-9.64 4.82 4.82 0 0 1 0 9.64Zm0-8.02a3.2 3.2 0 1 0 0 6.4 3.2 3.2 0 0 0 0-6.4Zm6.408-3.04a1.14 1.14 0 1 1-2.28 0 1.14 1.14 0 0 1 2.28 0Z" clip-rule="evenodd" /></svg>
                Instagram: @enhimanshu13
            </a>
            <a href="https://www.linkedin.com/in/himanshu-kumar-43a8b130b/" target="_blank" class="flex items-center gap-2 bg-gray-700 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors duration-300 w-full sm:w-auto justify-center">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                LinkedIn: Himanshu Kumar
            </a>
        </div>

        <button onclick="showCalculatorPage()" class="bg-blue-600 text-white py-3 px-6 rounded-lg text-lg font-bold hover:bg-blue-700 transition-all duration-300 shadow-md w-full sm:w-auto mx-auto block mt-8">
            ← Back to Calculator
        </button>
    </div>

    <!-- Side Navigation Menu -->
    <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-gray-900 text-white shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out z-[9997] flex flex-col p-5">
        <div class="flex justify-end w-full mb-4">
            <button id="close-sidebar" class="p-2 rounded-full bg-gray-700 text-white text-xl hover:bg-gray-600 transition-colors duration-300">
                ✖️
            </button>
        </div>
        <nav class="flex flex-col gap-4">
            <a href="#" class="menu-item text-xl font-semibold hover:text-yellow-500 transition-colors duration-200 py-2" onclick="toggleSidebarState(true); setTimeout(showCalculatorPage, 300); return false;">Calculator</a>
            <a href="#" class="menu-item text-xl font-semibold hover:text-yellow-500 transition-colors duration-200 py-2" onclick="toggleSidebarState(true); setTimeout(showSemesterHistoryPage, 300); return false;">Semester History</a>
            <a href="#" class="menu-item text-xl font-semibold hover:text-yellow-500 transition-colors duration-200 py-2" onclick="toggleSidebarState(true); setTimeout(showAboutUs, 300); return false;">About Us</a>
            <a href="#" class="menu-item text-xl font-semibold hover:text-yellow-500 transition-colors duration-200 py-2" onclick="toggleSidebarState(true); setTimeout(showContactUs, 300); return false;">Contact Us</a>
            <a href="#" class="menu-item text-xl font-semibold hover:text-yellow-500 transition-colors duration-200 py-2" onclick="toggleSidebarState(true); setTimeout(showDeveloperInfoPage, 300); return false;">Meet the Developer</a>
            <a href="#" class="menu-item text-xl font-semibold hover:text-yellow-500 transition-colors duration-200 py-2" onclick="toggleSidebarState(true); setTimeout(showAppVersion, 300); return false;">App Version</a>
        </nav>
        <div class="mt-auto text-center text-sm text-gray-500">
            Made with ❤️ LPU
        </div>
    </div>

    <!-- Overlay for when side nav is open -->
    <div id="sideNavOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-[9996]" style="display: none;"></div>

    <!-- Onboarding Tour Overlay -->
    <div id="onboardingTour" class="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-start pt-16 z-[9999] hidden">
        <div class="bg-gray-800 text-white p-6 rounded-lg shadow-xl max-w-md w-11/12 relative
                    sm:max-w-sm sm:absolute sm:top-8 sm:left-auto sm:right-8 sm:translate-x-0 sm:translate-y-0">
            <button id="skipTourButton" class="absolute top-1 right-1
                                               px-3 py-1 text-sm rounded-full border border-gray-600 text-gray-400
                                               hover:bg-gray-700 hover:text-white transition-colors duration-300">Skip Tour</button>
            <h3 id="tourTitle" class="text-xl font-bold mb-4 text-yellow-500">Welcome!</h3>
            <p id="tourContent" class="mb-6">Let's take a quick tour of the LPU TGPA & CGPA Calculator.</p>
            <div class="flex justify-between items-center">
                <button id="prevTourButton" class="bg-gray-700 text-white py-2 px-4 rounded-md hover:bg-gray-600 transition-colors duration-300 hidden">Previous</button>
                <button id="nextTourButton" class="bg-black text-yellow-500 py-2 px-4 rounded-md hover:bg-gray-900 transition-colors duration-300">Next</button>
                <button id="finishTourButton" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors duration-300 hidden">Finish</button>
            </div>
        </div>
    </div>

    <script>
        // Register Service Worker for PWA capabilities
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }

        // Global variable to track if initial load has occurred
        let isFirstLoad = true;

        // --- Predefined LPU Subjects for Suggestions ---
        const lpuSubjects = [
            "Applied Physics", "Applied Chemistry", "Engineering Graphics",
            "Basic Electrical Engineering", "Basic Electronics", "Programming in C",
            "Data Structures", "Object Oriented Programming", "Discrete Mathematics",
            "Operating Systems", "Computer Networks", "Database Management Systems",
            "Software Engineering", "Artificial Intelligence", "Machine Learning",
            "Web Technologies", "Cloud Computing", "Cyber Security",
            "Professional Communication", "Environmental Studies", "Constitution of India",
            "Human Values", "Mathematics-I", "Mathematics-II", "Mathematics-III",
            "Digital Electronics", "Microprocessor and Microcontroller",
            "Theory of Computation", "Compiler Design", "Distributed Systems",
            "Big Data Analytics", "Internet of Things", "Mobile Application Development",
            "Game Development", "Robotics", "Computer Graphics", "Image Processing",
            "Natural Language Processing", "Deep Learning", "Data Mining",
            "Cryptography and Network Security", "Software Testing", "Project Management",
            "Economics for Engineers", "Financial Management", "Marketing Management",
            "Organizational Behavior", "Entrepreneurship Development",
            "Foreign Language (French)", "Foreign Language (German)", "Foreign Language (Spanish)",
            "Universal Human Values",
            "CSE101 - Computer Programming",
            "ECE131 - Basic Electrical and Electronics Engineering",
            "ECE132 - Basic Electrical and Electronics Engineering Laboratory",
            "MTH165 - Mathematics for Engineers",
            "PES318 - Soft Skills-I",
            "MEC103 - Engineering Graphics",
            "MEC107 - Basic Engineering Mechanics",
            "CHE110 - Environmental Studies",
            "PHY109 - Engineering Physics",
            "PHY119 - Engineering Physics Laboratory",
            "CSE202 - Object Oriented Programming",
            "CSE326 - Internet Programming Laboratory",
            "ECE213 - Digital Electronics",
            "ECE216 - Digital Electronics Laboratory",
            "MTH166 - Differential Equations and Vector Calculus",
            "PEL121 - Communication Skills-I",
            "Data Structures and Algorithms",
            "Database Management Systems (DBMS)",
            "Software Engineering",
            "Object-Oriented Programming (Advanced)",
            "Web Technologies",
            "Programming Languages",
            "Operating Systems",
            "Computer Networks",
            "Computer Organization and Architecture",
            "Theory of Computation",
            "Compiler Design",
            "Design and Analysis of Algorithms",
            "Discrete Mathematics/Discrete Structures",
            "Probability and Statistics",
            "Linear Algebra and Ordinary Differential Equations",
            "Numerical Analysis",
            "Artificial Intelligence and Machine Learning",
            "Computer Graphics",
            "Cybersecurity/Network Security",
            "Data Science and Data Mining",
            "Cloud Computing",
            "Mobile Computing",
            "Digital Electronics and Logic Design",
            "Microprocessor and Microcontrollers",
            "Computer Architecture",
            "Professional Ethics",
            "Programming laboratories",
            "Hardware and Network Workshop",
            "Database programming labs",
            "Web development labs",
            "Internetworking Essentials practical",
            "Major Project/Thesis",
            "Industrial Training/Internship",
            "Seminar presentations",
            "Data Science",
            "Machine Learning and AI",
            "Cyber Security and Blockchain",
            "Full Stack Software Development",
            "Internet of Things (IoT)"
        ].sort(); // Sort alphabetically for better user experience

        // Function to show a custom message box instead of alert()
        function showMessageBox(message, onConfirm = null) {
            const overlay = document.createElement('div');
            overlay.className = 'message-box-overlay';
            overlay.innerHTML = `
                <div class="message-box">
                    <p>${message}</p>
                    <button class="message-box-button">OK</button>
                </div>
            `;
            document.body.appendChild(overlay);

            overlay.querySelector('.message-box-button').onclick = () => {
                document.body.removeChild(overlay);
                if (onConfirm) onConfirm();
            };
        }

        function getGradePoint(value) {
            if (!isNaN(value) && value !== "") { // Check for empty string too
                value = parseFloat(value);
                if (value >= 90) return 10;
                if (value >= 82) return 9;
                if (value >= 72) return 8;
                if (value >= 60) return 7;
                if (value >= 50) return 6;
                if (value >= 45) return 5;
                if (value >= 40) return 4;
                return 0;
            }
            value = String(value).toUpperCase().trim(); // Ensure it's a string and trim whitespace
            switch (value) {
                case "O": return 10;
                case "A+": return 9;
                case "A": return 8;
                case "B+": return 7;
                case "B": return 6;
                case "C": return 5;
                case "D": return 4;
                case "E": case "F": case "G": case "I": return 0;
                default: return 0; // Handle invalid inputs gracefully
            }
        }

        // New function to get LPU letter grade from marks or existing grade
        function getGradeLetter(value) {
            if (!isNaN(value) && value !== "") {
                value = parseFloat(value);
                if (value >= 90) return "O";
                if (value >= 82) return "A+";
                if (value >= 72) return "A";
                if (value >= 60) return "B+";
                if (value >= 50) return "B";
                if (value >= 45) return "C";
                if (value >= 40) return "D";
                return "F"; // Or "E" depending on LPU's exact lowest passing grade
            }
            // If it's already a letter grade, return it directly
            return String(value).toUpperCase().trim();
        }


        // --- TGPA Subject Data Functions (Local Storage) ---
        function saveSubjectData() {
            const data = Array.from(document.querySelectorAll("#gradeTable tbody tr")).map((row, index) => {
                return {
                    subject: row.querySelector('.subject-input').value,
                    grade: row.querySelector('.tgpa-input').value,
                    credit: row.querySelector('.credit-input').value
                };
            });
            localStorage.setItem("lpu_subject_data", JSON.stringify(data));
        }

        function loadSubjectData(isInitialLoad = false) {
            const data = JSON.parse(localStorage.getItem("lpu_subject_data") || "[]");
            const tableBody = document.querySelector("#gradeTable tbody");
            tableBody.innerHTML = ""; // Always clear first

            if (data.length === 0) {
                // If no saved data, populate with default rows based on slider
                for (let i = 0; i < parseInt(document.getElementById("subjectCount").value); i++) {
                    createAndAppendSubjectRow(i + 1);
                }
                if (!isInitialLoad) { // Only show message if autofill was clicked, not on initial load
                    // showMessageBox("No previous subject data found to autofill."); // Removed to avoid pop-up on initial empty load
                }
            } else {
                // If saved data exists, populate with saved data
                data.forEach((item, index) => {
                    const row = createAndAppendSubjectRow(index + 1); // Create row
                    row.querySelector('.subject-input').value = item.subject || `Subject ${index + 1}`;
                    row.querySelector('.tgpa-input').value = item.grade;
                    row.querySelector('.credit-input').value = item.credit;
                });
                // Sync slider to loaded data count
                document.getElementById("subjectCount").value = data.length;
                document.getElementById("subjectCountDisplay").innerText = data.length;

                // Only show message if it's NOT the initial load
                if (!isInitialLoad) {
                    showMessageBox("Previous subject data autofilled.");
                }
            }
            calculateTGPA(); // Recalculate TGPA after loading data
            isFirstLoad = false; // Mark first load as complete
        }

        // New helper function to create and append a single subject row
        function createAndAppendSubjectRow(index) {
            const table = document.querySelector("#gradeTable tbody");
            const row = document.createElement("tr");
            const subjectLabel = `Subject ${index}`;

            row.className = "bg-gray-900 even:bg-gray-850";
            row.innerHTML = `
                <td class="py-3 px-2 sm:px-4 border border-gray-700">
                    <div class="mobile-label-input-group">
                        <span class="mobile-label">Subject</span>
                        <div class="subject-input-wrapper">
                            <input type="text" placeholder="Subject" value="${subjectLabel}" class="w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500 subject-input">
                            <div class="subject-suggestions"></div>
                        </div>
                    </div>
                </td>
                <td class="py-3 px-2 sm:px-4 border border-gray-700">
                    <div class="mobile-label-input-group">
                        <span class="mobile-label">Grade/Marks</span>
                        <input type="text" placeholder="Grade or Marks" class="w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500 tgpa-input">
                        <span class="text-sm text-gray-400 grade-point-display block mt-1"></span>
                    </div>
                </td>
                <td class="py-3 px-2 sm:px-4 border border-gray-700">
                    <div class="mobile-label-input-group">
                        <span class="mobile-label">Credit</span>
                        <input type="number" placeholder="Credit" class="w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500 credit-input">
                    </div>
                </td>
                <td class="py-3 px-2 sm:px-4 border border-gray-700 text-center">
                    <button onclick="removeRow(this)" class="bg-red-600 text-white p-2 rounded-full hover:bg-red-700 transition-colors duration-300">❌</button>
                </td>`;
            table.appendChild(row);

            // Add event listeners for real-time calculation and grade point display
            const gradeInput = row.querySelector('.tgpa-input');
            const creditInput = row.querySelector('.credit-input');
            const subjectInput = row.querySelector('.subject-input');
            const suggestionsBox = row.querySelector('.subject-suggestions');

            // Event listener to clear input on click
            subjectInput.addEventListener('click', function() {
                this.value = '';
                handleSubjectInput(this); // Immediately show suggestions for empty input
            });

            // Event listener for input changes to trigger suggestions
            subjectInput.addEventListener('input', () => handleSubjectInput(subjectInput));

            // Event listener to hide suggestions when input loses focus
            subjectInput.addEventListener('blur', () => {
                // Delay hiding to allow click on suggestion to register
                setTimeout(() => {
                    suggestionsBox.style.display = 'none';
                }, 150);
            });

            gradeInput.addEventListener('input', () => {
                validateTGPAInput(gradeInput);
                calculateTGPA();
            });
            creditInput.addEventListener('input', () => {
                validateCreditInput(creditInput);
                calculateTGPA();
            });
            subjectInput.addEventListener('input', saveSubjectData); // Keep saving data
            return row;
        }

        // Function to handle subject input and display suggestions
        function handleSubjectInput(inputElement) {
            const query = inputElement.value.toLowerCase();
            const suggestionsBox = inputElement.nextElementSibling; // The div.subject-suggestions
            suggestionsBox.innerHTML = ''; // Clear previous suggestions

            if (query.length === 0 && inputElement.value.length === 0) { // Show all if input is empty and clicked
                 // Show all suggestions when input is empty (e.g., cleared on click)
                lpuSubjects.forEach(subject => {
                    createSuggestionItem(subject, suggestionsBox, inputElement);
                });
                suggestionsBox.style.display = lpuSubjects.length > 0 ? 'block' : 'none';
                return;
            }

            const filteredSuggestions = lpuSubjects.filter(subject =>
                subject.toLowerCase().includes(query)
            );

            if (filteredSuggestions.length > 0 && query.length > 0) { // Only show suggestions if there's a query
                filteredSuggestions.forEach(subject => {
                    createSuggestionItem(subject, suggestionsBox, inputElement);
                });
                suggestionsBox.style.display = 'block';
            } else {
                suggestionsBox.style.display = 'none';
            }
        }

        // Helper to create a single suggestion item
        function createSuggestionItem(text, container, inputElement) {
            const item = document.createElement('div');
            item.className = 'subject-suggestion-item';
            item.textContent = text;
            item.addEventListener('mousedown', (e) => { // Use mousedown to prevent blur before click
                e.preventDefault(); // Prevent input from losing focus
                inputElement.value = text;
                container.style.display = 'none'; // Hide suggestions
                saveSubjectData(); // Save data after selecting
            });
            container.appendChild(item);
        }


        // Input validation for TGPA section
        function validateTGPAInput(inputElement) {
            const value = inputElement.value.trim();
            const gradePoint = getGradePoint(value);
            const isNumeric = !isNaN(parseFloat(value)) && isFinite(value);

            // Check if it's a valid number between 0-100 or a recognized grade letter
            if ((isNumeric && parseFloat(value) >= 0 && parseFloat(value) <= 100) || (value !== "" && gradePoint >= 0)) {
                inputElement.classList.remove('border-red-500');
            } else {
                inputElement.classList.add('border-red-500');
            }
        }

        function validateCreditInput(inputElement) {
            const value = parseFloat(inputElement.value);
            if (isNaN(value) || value <= 0 || value > 100) { // Assuming max credits per subject is 100
                inputElement.classList.add('border-red-500');
            } else {
                inputElement.classList.remove('border-red-500');
            }
        }

        function calculateTGPA() {
            let rows = document.querySelectorAll("#gradeTable tbody tr");
            let totalPoints = 0, totalCredits = 0;
            let hasInvalidInput = false;

            rows.forEach(row => {
                let inputElement = row.querySelector('.tgpa-input');
                let creditElement = row.querySelector('.credit-input');
                let gradePointDisplay = row.querySelector('.grade-point-display');

                let input = inputElement.value.trim();
                let credit = parseFloat(creditElement.value);
                let point = getGradePoint(input);

                // Update grade point display
                gradePointDisplay.textContent = ` (GP: ${point})`;

                // Apply validation styles
                validateTGPAInput(inputElement);
                validateCreditInput(creditElement);

                if (inputElement.classList.contains('border-red-500') || creditElement.classList.contains('border-red-500')) {
                    hasInvalidInput = true;
                } else {
                    totalPoints += point * credit;
                    totalCredits += credit;
                }
            });

            if (hasInvalidInput) {
                document.getElementById("result").innerHTML = `<strong>TGPA:</strong> Invalid Input (Check highlighted fields)`;
                document.getElementById('saveCurrentSemesterBtn').classList.add('hidden'); // Hide save button if invalid
                return;
            }

            saveSubjectData();

            let tgpa = totalCredits ? (totalPoints / totalCredits).toFixed(2) : "N/A";
            document.getElementById("result").innerHTML = `Total Grade Points: ${totalPoints}<br>Total Credits: ${totalCredits}<br><strong>TGPA:</strong> ${tgpa}`;

            // Show save button if TGPA is valid and calculated
            if (tgpa !== "N/A") {
                document.getElementById('saveCurrentSemesterBtn').classList.remove('hidden');
            } else {
                document.getElementById('saveCurrentSemesterBtn').classList.add('hidden');
            }
        }

        function addRow() {
            const table = document.querySelector("#gradeTable tbody");
            const newRowCount = table.rows.length + 1;
            createAndAppendSubjectRow(newRowCount);

            document.getElementById("subjectCount").value = newRowCount;
            document.getElementById("subjectCountDisplay").innerText = newRowCount;
            calculateTGPA();
        }

        function removeRow(btn) {
            const row = btn.closest("tr");
            row.remove();

            const table = document.querySelector("#gradeTable tbody");
            const currentSubjectCount = table.rows.length;
            document.getElementById("subjectCount").value = currentSubjectCount;
            document.getElementById("subjectCountDisplay").innerText = currentSubjectCount;

            saveSubjectData();
            calculateTGPA();
        }

        function resetCurrentTable() {
            const tableBody = document.querySelector("#gradeTable tbody");
            tableBody.innerHTML = "";
            showMessageBox("Current subject table reset to default.");
            for (let i = 0; i < parseInt(document.getElementById("subjectCount").value); i++) {
                createAndAppendSubjectRow(i + 1);
            }
            calculateTGPA();
        }

        function deleteCurrentSubjectsData() {
            showMessageBox("Are you sure you want to delete the saved data for the current subjects? This cannot be undone.", () => {
                localStorage.removeItem("lpu_subject_data");
                showMessageBox("Current subject data cleared and saved data deleted!");
                resetCurrentTable();
            });
        }

        function deleteSavedData() {
            showMessageBox("Are you sure you want to delete ALL saved data (current semester subjects and previous semesters)? This cannot be undone.", () => {
                localStorage.removeItem("lpu_subject_data");
                localStorage.removeItem("lpu_semester_data"); // This is for CGPA calculation inputs
                localStorage.removeItem("lpu_semester_history"); // The main history data

                showMessageBox("All local saved data deleted.");
                
                resetCurrentTable();
                document.getElementById("semesters").innerHTML = "";
                calculateTGPA();
                calculateCGPA();
                renderSemesterHistoryPage(); // Update history page
            });
        }

        function autofillSubjects() {
            loadSubjectData(false);
            loadSemesterData(false);
        }

        function updateSubjectCount(val) {
            document.getElementById("subjectCountDisplay").innerText = val;
            const tableBody = document.querySelector("#gradeTable tbody");
            const currentRowCount = tableBody.rows.length;

            if (currentRowCount > val) {
                for (let i = currentRowCount - 1; i >= val; i--) {
                    tableBody.deleteRow(i);
                }
            } else if (currentRowCount < val) {
                for (let i = currentRowCount; i < val; i++) {
                    createAndAppendSubjectRow(i + 1);
                }
            }
            saveSubjectData();
            calculateTGPA();
        }

        // --- CGPA Semester Data Functions (Local Storage) ---
        function saveSemesterData() {
            const data = Array.from(document.querySelectorAll("#semesters .semester")).map((div, index) => {
                return {
                    tgpa: div.querySelector('.tgpa').value,
                    credit: div.querySelector('.credit').value
                };
            });
            localStorage.setItem("lpu_semester_data", JSON.stringify(data));
        }

        function loadSemesterData(isInitialLoad = false) {
            const data = JSON.parse(localStorage.getItem("lpu_semester_data") || "[]");
            document.getElementById("semesters").innerHTML = "";
            if (data.length === 0) {
                // No default semesters added on initial load for CGPA calculator, user can add manually
            } else {
                data.forEach((item, index) => {
                    addSemester();
                    const lastSemesterDiv = document.querySelector("#semesters").lastElementChild;
                    lastSemesterDiv.querySelector('.tgpa').value = item.tgpa;
                    lastSemesterDiv.querySelector('.credit').value = item.credit;
                });
            }
            calculateCGPA();
        }

        function addSemester() {
            const container = document.getElementById("semesters");
            const count = container.children.length + 1;
            const div = document.createElement("div");
            div.className = "semester bg-gray-800 p-4 rounded-md flex flex-col sm:flex-row items-center gap-4";
            div.innerHTML = `
                <label class="flex-grow w-full">Semester ${count} TGPA:
                    <input type="number" step="0.01" class="tgpa w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </label>
                <label class="flex-grow w-full">Credits:
                    <input type="number" placeholder="Credits" class="credit w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </label>
                <button onclick="removeSemester(this)" class="bg-red-600 text-white p-2 rounded-full hover:bg-red-700 transition-colors duration-300 flex-shrink-0">❌ Remove</button>`;
            container.appendChild(div);

            const tgpaInput = div.querySelector('.tgpa');
            const creditInput = div.querySelector('.credit');
            tgpaInput.addEventListener('input', () => {
                validateCgpaInput(tgpaInput);
                calculateCGPA();
            });
            creditInput.addEventListener('input', () => {
                validateCreditInput(creditInput); // Re-using credit validation
                calculateCGPA();
            });
            calculateCGPA();
        }

        // Input validation for CGPA section TGPA input
        function validateCgpaInput(inputElement) {
            const value = parseFloat(inputElement.value);
            if (isNaN(value) || value < 0 || value > 10) {
                inputElement.classList.add('border-red-500');
            } else {
                inputElement.classList.remove('border-red-500');
            }
        }

        function removeSemester(btn) {
            const div = btn.closest(".semester");
            div.remove();
            saveSemesterData();
            calculateCGPA();
            // Re-label semesters after removal
            Array.from(document.querySelectorAll("#semesters .semester label:first-child")).forEach((label, index) => {
                label.innerHTML = `Semester ${index + 1} TGPA:<br>${label.innerHTML.split('<br>')[1]}`;
            });
        }

        function calculateCGPA() {
            const tgs = document.querySelectorAll(".tgpa");
            const crs = document.querySelectorAll(".credit");
            let totalPoints = 0, totalCredits = 0;
            let hasInvalidInput = false;

            for (let i = 0; i < tgs.length; i++) {
                let tgElement = tgs[i];
                let crElement = crs[i];

                let tg = parseFloat(tgElement.value);
                let cr = parseFloat(crElement.value);

                // Apply validation styles
                validateCgpaInput(tgElement);
                validateCreditInput(crElement);

                if (tgElement.classList.contains('border-red-500') || crElement.classList.contains('border-red-500')) {
                    hasInvalidInput = true;
                } else {
                    totalPoints += tg * cr;
                    totalCredits += cr;
                }
            }

            if (hasInvalidInput) {
                document.getElementById("cgpaResult").innerHTML = `<strong>CGPA:</strong> Invalid Input (Check highlighted fields)`;
                return;
            }

            saveSemesterData();

            let cgpa = totalCredits ? (totalPoints / totalCredits).toFixed(2) : "N/A";
            document.getElementById("cgpaResult").innerHTML = `<strong>CGPA:</strong> ${cgpa}`;
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let tgpaResult = document.getElementById("result").innerText;
            let cgpaResult = document.getElementById("cgpaResult").innerText;
            const currentDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            doc.setFontSize(22);
            doc.setTextColor(0, 0, 0);
            doc.text("LPU TGPA CALCULATION", doc.internal.pageSize.width / 2, 20, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`Report Generated: ${currentDate}`, doc.internal.pageSize.width - 20, 30, { align: 'right' });

            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text("Current Semester Subjects:", 20, 50);

            const subjectData = [];
            document.querySelectorAll("#gradeTable tbody tr").forEach(row => {
                const subject = row.querySelector('.subject-input').value;
                const grade = row.querySelector('.tgpa-input').value;
                const credit = row.querySelector('.credit-input').value;
                const gradePoint = getGradePoint(grade);
                subjectData.push([subject, grade, credit, gradePoint]);
            });

            doc.autoTable({
                startY: 60,
                head: [['Subject', 'Grade/Marks', 'Credit', 'Grade Point']],
                body: subjectData,
                theme: 'grid',
                styles: { fontSize: 10, cellPadding: 2, overflow: 'linebreak', textColor: [0, 0, 0] },
                headStyles: { fillColor: [0, 0, 0], textColor: [255, 203, 5], fontStyle: 'bold' },
                alternateRowStyles: { fillColor: [245, 245, 245] },
                margin: { left: 20, right: 20 }
            });

            let finalY = doc.autoTable.previous.finalY;

            doc.setFontSize(12);
            doc.text("TGPA Calculation:", 20, finalY + 15);
            doc.setFontSize(10);
            tgpaResult.split('<br>').forEach((line, index) => {
                doc.text(line.replace(/<\/?strong>/g, ''), 20, finalY + 25 + (index * 5));
            });

            finalY += (tgpaResult.split('<br>').length * 5) + 25;

            doc.setFontSize(14);
            doc.text("Previous Semesters Data:", 20, finalY + 15);

            const semesterData = [];
            document.querySelectorAll("#semesters .semester").forEach((div, index) => {
                const tgpa = div.querySelector('.tgpa').value;
                const credit = div.querySelector('.credit').value;
                semesterData.push([`Semester ${index + 1}`, tgpa, credit]);
            });

            doc.autoTable({
                startY: finalY + 25,
                head: [['Semester', 'TGPA', 'Credits']],
                body: semesterData,
                theme: 'grid',
                styles: { fontSize: 10, cellPadding: 2, overflow: 'linebreak', textColor: [0, 0, 0] },
                headStyles: { fillColor: [0, 0, 0], textColor: [255, 203, 5], fontStyle: 'bold' },
                alternateRowStyles: { fillColor: [245, 245, 245] },
                margin: { left: 20, right: 20 }
            });

            finalY = doc.autoTable.previous.finalY;

            doc.setFontSize(12);
            doc.text("CGPA Calculation:", 20, finalY + 15);
            doc.setFontSize(10);
            doc.text(cgpaResult.replace(/<\/?strong>/g, ''), 20, finalY + 25);

            doc.save("LPU_Report.pdf");
        }

        // --- Share Button Logic ---
        async function shareReport() {
            const tgpaResultText = document.getElementById('result').innerText;
            const cgpaResultText = document.getElementById('cgpaResult').innerText;

            // Get subject data for the image
            const subjectsData = [];
            document.querySelectorAll("#gradeTable tbody tr").forEach(row => {
                const subject = row.querySelector('.subject-input').value;
                const gradeInput = row.querySelector('.tgpa-input').value; // Get the raw input
                const gradeLetter = getGradeLetter(gradeInput); // Convert to LPU letter grade
                subjectsData.push({ subject, grade: gradeLetter }); // Store the letter grade
            });

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Define base dimensions and line heights
            const canvasWidth = 600;
            const headerHeight = 90;
            const sectionTitleHeight = 35; // Height for "Current Semester Subjects:", "Current Semester TGPA:", "Overall CGPA:"
            const subjectLineHeight = 25;
            const resultLineHeight = 25; // For lines like "Total Grade Points: X"
            const footerHeight = 40;
            const padding = 20;

            // Calculate dynamic canvas height
            let dynamicHeight = headerHeight;
            if (subjectsData.length > 0) {
                dynamicHeight += sectionTitleHeight; // "Current Semester Subjects:" title
                dynamicHeight += subjectsData.length * subjectLineHeight; // Each subject line
                dynamicHeight += padding; // Space after subjects
            }
            dynamicHeight += sectionTitleHeight; // "Current Semester TGPA:" title
            dynamicHeight += tgpaResultText.split('\n').length * resultLineHeight; // TGPA result lines
            dynamicHeight += padding; // Space after TGPA
            dynamicHeight += sectionTitleHeight; // "Overall CGPA:" title
            dynamicHeight += resultLineHeight; // CGPA result line
            dynamicHeight += padding; // Space after CGPA
            dynamicHeight += footerHeight; // Footer

            canvas.width = canvasWidth;
            canvas.height = dynamicHeight;

            // Set background color based on current theme
            const isDarkMode = document.body.classList.contains('dark-mode');
            ctx.fillStyle = isDarkMode ? '#1f1f1f' : '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Set text color based on current theme
            ctx.fillStyle = isDarkMode ? '#ffffff' : '#212529'; // White for dark, dark gray for light

            let yOffset = 50;

            // Title
            ctx.font = 'bold 24px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('LPU TGPA & CGPA Report', canvasWidth / 2, yOffset);
            yOffset += 40; // Space after title

            // Current Semester Subjects
            if (subjectsData.length > 0) {
                ctx.font = 'bold 18px Inter';
                ctx.textAlign = 'left';
                ctx.fillText('Current Semester Subjects:', 50, yOffset);
                yOffset += sectionTitleHeight; // Move down for subject list

                ctx.font = '16px Inter';
                subjectsData.forEach(item => {
                    // Display subject name and LPU letter grade
                    ctx.fillText(`${item.subject}: ${item.grade}`, 70, yOffset);
                    yOffset += subjectLineHeight;
                });
                yOffset += padding; // Add some space after subjects
            }


            // TGPA Result
            ctx.font = 'bold 18px Inter';
            ctx.textAlign = 'left';
            ctx.fillText('Current Semester TGPA:', 50, yOffset);
            yOffset += sectionTitleHeight; // Move down for TGPA lines
            const tgpaLines = tgpaResultText.split('\n');
            tgpaLines.forEach(line => {
                ctx.font = '16px Inter'; // Smaller font for detail lines
                ctx.fillText(line.trim(), 70, yOffset);
                yOffset += resultLineHeight;
            });
            yOffset += padding; // Add some space

            // CGPA Result
            ctx.font = 'bold 18px Inter';
            ctx.fillText('Overall CGPA:', 50, yOffset);
            yOffset += sectionTitleHeight; // Move down for CGPA line
            ctx.font = '16px Inter';
            ctx.fillText(cgpaResultText.trim(), 70, yOffset);
            yOffset += resultLineHeight; // Move down for footer placement

            // Add a footer
            ctx.font = '12px Inter';
            ctx.textAlign = 'center';
            ctx.fillStyle = isDarkMode ? '#888888' : '#6c757d'; // Lighter gray for footer
            ctx.fillText(`Generated by LPU TGPA & CGPA Calculator | ${window.location.origin}`, canvasWidth / 2, canvas.height - 20);

            // Convert canvas to Blob (PNG)
            canvas.toBlob(async (blob) => {
                if (!blob) {
                    showMessageBox('Failed to generate image for sharing.');
                    return;
                }

                const file = new File([blob], 'LPU_Report.png', { type: 'image/png' });

                console.log('Attempting to share report...');
                console.log('navigator.share available:', !!navigator.share);
                console.log('navigator.canShare files available:', !!(navigator.canShare && navigator.canShare({ files: [file] })));

                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'LPU TGPA & CGPA Calculator Report',
                            text: 'Check out my LPU TGPA/CGPA results!',
                            url: window.location.href
                        });
                        showMessageBox('Report shared successfully!');
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            console.log('Share cancelled by user.');
                            showMessageBox('Share operation cancelled.');
                        } else {
                            console.error('Error sharing via Web Share API:', error);
                            showMessageBox('Failed to share report via native sharing. Downloading image instead.');
                            // Fallback to download if native share fails
                            downloadImage(blob, 'LPU_Report.png');
                        }
                    }
                } else {
                    showMessageBox('Native image sharing is not supported in this browser or environment. Downloading image instead.');
                    downloadImage(blob, 'LPU_Report.png');
                }
            }, 'image/png');
        }

        // New function to download any blob as an image
        function downloadImage(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessageBox('Image downloaded successfully!');
        }


        // Theme Toggle Logic
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;

        function applyTheme(theme) {
            if (theme === 'dark') {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                themeToggle.textContent = '💡';
            } else {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                themeToggle.textContent = '🌙';
            }
            localStorage.setItem('theme', theme);
        }

        themeToggle.addEventListener('click', () => {
            if (body.classList.contains('dark-mode')) {
                applyTheme('light');
            } else {
                applyTheme('dark');
            }
        });

        // --- Sidebar State Management (Centralized) ---
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sideNavOverlay');
        const toggleBarButton = document.getElementById('toggle-bar');

        function toggleSidebarState(forceClose = false) {
            const currentActivePage = document.querySelector('#mainCalculatorContent:not(.hidden), #semesterHistoryPage:not(.hidden), #developerInfoPage:not(.hidden)');
            const isActive = sidebar.classList.contains('active');

            if (isActive || forceClose) { // If active or forced to close
                sidebar.classList.remove('active');
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.style.display = 'none';
                if (currentActivePage) {
                    currentActivePage.classList.remove('dimmed-content');
                }
                toggleBarButton.textContent = '☰';
            } else { // If not active
                sidebar.classList.add('active');
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.style.display = 'block';
                if (currentActivePage) {
                    currentActivePage.classList.add('dimmed-content');
                }
                toggleBarButton.textContent = '✖️';
            }
        }

        // --- jQuery Event Handling for Sidebar ---
        $(document).ready(function() {
            var mquery = window.matchMedia("(max-width: 640px)"); // Using 640px for Tailwind's 'sm' breakpoint

            // Toggle sidebar on button click
            $('#toggle-bar').on('click', function() {
                toggleSidebarState();
            });
            
            // Close sidebar on dedicated close button click
            $('#close-sidebar').on('click', function() {
                toggleSidebarState(true); // Force close
            });

            // Auto-close sidebar on mobile when menu items are clicked
            $('.menu-item').on('click', function() {
                if (mquery.matches) {
                    // This is now handled by the `onclick` attributes on the anchor tags directly
                    // which call `toggleSidebarState(true)` and then `setTimeout(showPage, 300)`.
                }
            });
            
            // Close sidebar when clicking outside on mobile
            $('#sideNavOverlay').on('click', function() {
                if (mquery.matches) {
                    toggleSidebarState(true); // Force close
                }
            });
            
            // Close sidebar on window resize if switching to desktop
            $(window).on('resize', function() {
                if (!mquery.matches) { // If it's desktop size
                    toggleSidebarState(true); // Force close
                }
            });
        });

        // --- Swipe to close functionality (Plain JS, still useful) ---
        let touchStartX = 0;
        let touchEndX = 0;
        const swipeThreshold = 50; // Minimum pixels for a swipe to register

        sidebar.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
        });

        sidebar.addEventListener('touchmove', (e) => {
            touchEndX = e.touches[0].clientX;
            const deltaX = touchEndX - touchStartX;
            
            // Only allow dragging if the menu is open and swipe is to the right
            if (sidebar.classList.contains('active') && deltaX > 0) {
                const navWidth = sidebar.offsetWidth;
                const newTranslateXPercentage = Math.min(0, -100 + (deltaX / navWidth) * 100);
                sidebar.style.transform = `translateX(${newTranslateXPercentage}%)`;
            }
        });

        sidebar.addEventListener('touchend', () => {
            const deltaX = touchEndX - touchStartX;
            
            if (sidebar.classList.contains('active')) {
                if (deltaX > swipeThreshold) { // If swiped enough to the right
                    toggleSidebarState(true); // Close the nav
                } else {
                    // Snap back to fully open if not swiped enough
                    sidebar.style.transform = 'translateX(0)';
                }
            }
            // Reset touch positions
            touchStartX = 0;
            touchEndX = 0;
        });


        function scrollToSection(id) {
            const element = document.getElementById(id);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth' });
            }
        }

        const APP_VERSION = "1.0.0"; // Define your app version here
        const DEVELOPER_NAME = "Himanshu Kumar"; // Updated with your name

        function showAboutUs() {
            showMessageBox("<h3>About This App</h3><p>This LPU TGPA & CGPA Calculator helps students easily compute their academic performance. It stores data locally for convenience and can generate PDF reports.</p>");
        }

        function showContactUs() {
            showMessageBox(`<h3>Contact Us</h3><p>For support or feedback, please contact me at: <br> Email: <a href="mailto:himanshu748808@gmail.com" class="text-yellow-500 hover:underline">himanshu748808@gmail.com</a></p>`);
        }

        function showDeveloperInfoPage() {
            // Ensure all other main content pages are hidden
            mainCalculatorContent.classList.add('hidden');
            semesterHistoryPage.classList.add('hidden');
            // Show the developer info page
            developerInfoPage.classList.remove('hidden');
            // Hide burger button when on this page, if it was visible
            if (window.innerWidth < 640) {
                toggleBarButton.classList.add('hidden-on-scroll'); 
            }
        }

        function showAppVersion() {
            showMessageBox(`<h3>App Version</h3><p>Version: ${APP_VERSION}</p><p>Last Updated: June 2025</p>`);
        }

        // --- Onboarding Tour Logic ---
        const onboardingTour = document.getElementById('onboardingTour');
        const tourTitle = document.getElementById('tourTitle');
        const tourContent = document.getElementById('tourContent');
        const prevTourButton = document.getElementById('prevTourButton');
        const nextTourButton = document.getElementById('nextTourButton');
        const finishTourButton = document.getElementById('finishTourButton');
        const skipTourButton = document.getElementById('skipTourButton');

        let currentTourStep = 0;

        const tourSteps = [
            {
                title: "Welcome to LPU Calculator!",
                content: "This tool helps you calculate your current semester's TGPA and your overall CGPA easily.",
                element: null
            },
            {
                title: "Number of Subjects",
                content: "Use this slider to quickly adjust how many subjects you want to enter for the current semester.",
                element: "subjectCount"
            },
            {
                title: "Subject Details",
                content: "Enter the grade (or marks out of 100) and credits for each subject. The Grade Point (GP) will show automatically.",
                element: "gradeTable"
            },
            {
                title: "TGPA Calculation",
                content: "Click 'Calculate TGPA' to get your current semester's result. You can also add/remove subjects or autofill previous data.",
                element: "result"
            },
            {
                title: "Semester Data for CGPA",
                content: "Add your previous semester TGPAs and total credits here to calculate your Cumulative Grade Point Average (CGPA).",
                element: "semesters"
            },
            {
                title: "CGPA Calculation",
                content: "Once you've entered all your previous semesters, click 'Calculate CGPA' to see your overall academic performance.",
                element: "cgpaResult"
            },
            {
                title: "Download PDF Report",
                content: "Generate a summary of your calculations in a printable PDF format.",
                element: "generatePDF"
            },
            {
                title: "Dark/Light Mode",
                content: "Toggle between dark and light themes for your preference.",
                element: "themeToggle"
            },
            {
                title: "All Done!",
                content: "You're ready to start calculating! All your data is saved automatically in your browser.",
                element: null
            }
        ];

        function showTourStep(stepIndex) {
            currentTourStep = stepIndex;
            const step = tourSteps[stepIndex];

            tourTitle.textContent = step.title;
            tourContent.textContent = step.content;

            prevTourButton.classList.toggle('hidden', stepIndex === 0);
            nextTourButton.classList.toggle('hidden', stepIndex === tourSteps.length - 1);
            finishTourButton.classList.toggle('hidden', stepIndex !== tourSteps.length - 1);

            onboardingTour.classList.remove('hidden');

            document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
            if (step.element) {
                const elementToHighlight = document.getElementById(step.element);
                if (elementToHighlight) {
                    elementToHighlight.classList.add('tour-highlight');
                    elementToHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        function nextTourStep() {
            if (currentTourStep < tourSteps.length - 1) {
                showTourStep(currentTourStep + 1);
            } else {
                finishTour();
            }
        }

        function prevTourStep() {
            if (currentTourStep > 0) {
                showTourStep(currentTourStep - 1);
            }
        }

        function finishTour() {
            onboardingTour.classList.add('hidden');
            localStorage.setItem('hasViewedTour', 'true');
            document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
        }

        nextTourButton.addEventListener('click', nextTourStep);
        prevTourButton.addEventListener('click', prevTourStep);
        finishTourButton.addEventListener('click', finishTour);
        skipTourButton.addEventListener('click', finishTour);

        let lastScrollY = 0;

        function handleScroll() {
            // Only apply this behavior on small screens (mobile)
            if (window.innerWidth < 640) { // Tailwind's 'sm' breakpoint is 640px
                const currentScrollY = window.scrollY;

                // Check if any of the secondary pages are currently active
                const isSecondaryPageActive = !semesterHistoryPage.classList.contains('hidden') || !developerInfoPage.classList.contains('hidden');

                if (currentScrollY > lastScrollY && currentScrollY > 50) { // Scrolling down and not near the very top
                    if (!sidebar.classList.contains('active') && !isSecondaryPageActive) { // Only hide if side nav is not open AND not on a secondary page
                        toggleBarButton.classList.add('hidden-on-scroll');
                    }
                } else if (currentScrollY < lastScrollY || currentScrollY < 50) { // Scrolling up or near the very top
                    if (!isSecondaryPageActive) { // Only show if not on a secondary page
                        toggleBarButton.classList.remove('hidden-on-scroll');
                    }
                }
                lastScrollY = currentScrollY;
            } else {
                // Ensure it's not hidden if resized to desktop from mobile while hidden
                toggleBarButton.classList.remove('hidden-on-scroll');
            }
        }

        window.addEventListener('scroll', handleScroll);
        window.addEventListener('resize', handleScroll); // Re-evaluate on resize


        // --- Page Navigation Functions ---
        // const historyUserInfo = document.getElementById('historyUserInfo'); // No longer dynamic with auth

        function showCalculatorPage() {
            mainCalculatorContent.classList.remove('hidden');
            semesterHistoryPage.classList.add('hidden');
            developerInfoPage.classList.add('hidden'); // Hide developer page
            // Ensure burger button is visible when returning to calculator page on mobile
            if (window.innerWidth < 640) {
                toggleBarButton.classList.remove('hidden-on-scroll'); 
            }
        }

        function showSemesterHistoryPage() {
            mainCalculatorContent.classList.add('hidden');
            developerInfoPage.classList.add('hidden'); // Hide developer page
            semesterHistoryPage.classList.remove('hidden');
            renderSemesterHistoryPage(); // Render history when navigating to it
            // Hide burger button when on history page, if it was visible
            if (window.innerWidth < 640) {
                toggleBarButton.classList.add('hidden-on-scroll'); 
            }
        }

        // --- Local Storage History Functions ---
        function saveCurrentSemesterToHistory() {
            console.log("Save button clicked."); // Debugging: Log when button is clicked
            const resultDiv = document.getElementById('result');
            const tgpaText = resultDiv.innerText; // Get all text from the result div
            console.log("Result div innerText:", tgpaText); // Debugging: See the full text

            const tgpaTextMatch = tgpaText.match(/TGPA:\s*([\d.]+)/);
            const totalCreditsTextMatch = tgpaText.match(/Total Credits:\s*([\d.]+)/);

            if (!tgpaTextMatch || !totalCreditsTextMatch) {
                showMessageBox("Cannot save: TGPA or Total Credits not found. Please calculate TGPA first.");
                console.log("Save failed: TGPA or Total Credits not found. tgpaTextMatch:", tgpaTextMatch, "totalCreditsTextMatch:", totalCreditsTextMatch); // More detailed debug
                return;
            }

            const tgpa = parseFloat(tgpaTextMatch[1]);
            const totalCredits = parseFloat(totalCreditsTextMatch[1]);
            console.log("Extracted TGPA:", tgpa, "Extracted Credits:", totalCredits); // Debugging: Log extracted values


            if (isNaN(tgpa) || isNaN(totalCredits) || totalCredits <= 0) {
                showMessageBox("Cannot save: Invalid TGPA or Credits for current semester.");
                console.log("Save failed: Invalid TGPA or Credits.", { tgpa, totalCredits, isTGPA_NaN: isNaN(tgpa), isCredits_NaN: isNaN(totalCredits), isCredits_ZeroOrLess: totalCredits <= 0 }); // Even more detailed debug
                return;
            }

            const semesterData = {
                tgpa: tgpa,
                credits: totalCredits,
                date: new Date().toLocaleDateString(),
                timestamp: Date.now() // Add a timestamp for ordering
            };

            let history = JSON.parse(localStorage.getItem("lpu_semester_history") || "[]");
            history.push(semesterData);
            localStorage.setItem("lpu_semester_history", JSON.stringify(history));
            showMessageBox("Current semester data saved to local history!");
            console.log("Data saved to local storage:", semesterData); // Debugging: Confirm save
            
            showSemesterHistoryPage(); // Navigate to history page after saving
        }

        function renderSemesterHistoryPage() {
            const savedSemestersList = document.getElementById('savedSemestersList');
            savedSemestersList.innerHTML = ''; // Clear previous entries

            let history = JSON.parse(localStorage.getItem("lpu_semester_history") || "[]");
            
            if (history.length === 0) {
                savedSemestersList.innerHTML = '<p class="text-center text-gray-400">No semester data saved yet locally.</p>';
                return;
            }

            // Sort history by timestamp (most recent last)
            history.sort((a, b) => a.timestamp - b.timestamp);

            history.forEach((semester, index) => {
                const semesterDiv = document.createElement('div');
                semesterDiv.className = 'bg-gray-800 p-4 rounded-md flex flex-col sm:flex-row items-center justify-between gap-4';
                semesterDiv.innerHTML = `
                    <div>
                        <p class="text-lg font-semibold">Semester ${index + 1}:</p>
                        <p>TGPA: <span class="text-yellow-500 font-bold">${semester.tgpa.toFixed(2)}</span></p>
                        <p>Credits: <span class="text-yellow-500 font-bold">${semester.credits}</span></p>
                        <p class="text-sm text-gray-400">Saved on: ${semester.date}</p>
                    </div>
                    <button onclick="deleteSemesterFromHistory(${index})" class="bg-red-600 text-white p-2 rounded-full hover:bg-red-700 transition-colors duration-300 flex-shrink-0">
                        🗑️ Delete
                    </button>
                `;
                savedSemestersList.appendChild(semesterDiv);
            });
        }

        function deleteSemesterFromHistory(indexToDelete) {
            showMessageBox("Are you sure you want to delete this semester record from history? This cannot be undone.", () => {
                let history = JSON.parse(localStorage.getItem("lpu_semester_history") || "[]");
                history.splice(indexToDelete, 1); // Remove the item at the specified index
                localStorage.setItem("lpu_semester_history", JSON.stringify(history));
                showMessageBox("Semester record deleted from local history.");
                renderSemesterHistoryPage(); // Re-render the list after deletion
            });
        }

        window.onload = function () {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);

            loadSubjectData(true);
            loadSemesterData(true); // Load for CGPA calculation inputs

            const hasViewedTour = localStorage.getItem('hasViewedTour');
            if (!hasViewedTour) {
                showTourStep(0);
            }

            // Initial check for burger button visibility on load
            handleScroll(); 
        };
    </script>
</body>
</html>
